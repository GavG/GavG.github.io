<html>

<head>
  <title>Botengine Archive Exporter</title>

</head>

<body>
  <form onsubmit='main(); return false;'>
    <label for='token'>DEVELOPER_ACCESS_TOKEN</label>
    <input type='text' id='token' name='token'></input>
    <button type='submit'>Export to CSV</button>
  </form>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous" /></script>

  <script type='text/javascript'>

  var token = '';

    function main() {
      token = $('#token').val();

      if (!token) {
        return alert('The DEVELOPER_ACCESS_TOKEN field must be populated');
      }
      getArchiveList();
    }

    function getArchiveList() {
      $.ajax({
        url: "https://api.botengine.ai/archives",
        success: function(data, status) {
          processArchiveList(data);
        },
        error: function(xhr, textStatus, errorThrown){
           alert('request failed - '+errorThrown);
        },
        beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + token); }
      });
    }

    function getArchive(id){
      return 'hi';
    }

    function processArchiveList(list) {

      var results = [];

      for (i = 0; i < list.length; ++i) {
        $.ajax({
          url: "https://api.botengine.ai/archives/"+list[i].id,
          success: function(data, status) {
            results.push(data);
          },
          error: function(xhr, textStatus, errorThrown){
             alert('request failed - '+errorThrown);
          },
          beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + token); }
        });
      }

      console.log(results);
    }
  </script>
</body>

</html>
