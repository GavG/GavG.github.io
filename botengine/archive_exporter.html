<html>

<head>
  <title>Botengine Archive Exporter</title>

</head>

<body>
  <form onsubmit='main(); return false;'>
    <label for='token'>DEVELOPER_ACCESS_TOKEN</label>
    <input type='text' id='token' name='token'></input>
    <button type='submit'>Export to CSV</button>
  </form>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous" /></script>

  <script type='text/javascript'>

  var token = '';

    function main() {
      token = $('#token').val();

      if (!token) {
        return alert('The DEVELOPER_ACCESS_TOKEN field must be populated');
      }
      getArchiveList();
    }

    function getArchiveList() {
      $.ajax({
        url: "https://api.botengine.ai/archives",
        success: function(data, status) {
          processArchiveList(data);
        },
        error: function(xhr, textStatus, errorThrown){
           alert('request failed - '+errorThrown);
        },
        beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + token); }
      });
    }

    function getArchive(id){
      return 'hi';
    }

    function flatten(arr) {
      return arr.reduce(function (flat, toFlatten) {
        return flat.concat(Array.isArray(toFlatten) ? flatten(toFlatten) : toFlatten);
      }, []);
    }

    function processArchiveList(list) {

      var results = [];

      for (i = 0; i < list.length; ++i) {
        $.ajax({
          url: "https://api.botengine.ai/archives/"+list[i].id,
          success: function(data, status) {
            results.push(data);
          },
          error: function(xhr, textStatus, errorThrown){
             alert('request failed - '+errorThrown);
          },
          beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + token); }
        });
      }

      console.log(flatten(results).join(','));

      return false;

      var csvContent = "data:text/csv;charset=utf-8,";
      for (j = 0; j < results.length; ++j) {
         var r = results[j];
         var cs = r.conversation;

         for (k = 0; k < cs.length; ++k) {
           var m = cs[k];
            var row = [r.id, r.sessionId, r.date, m.confidence, m.date, ].join(",");
         }


         csvContent += row + "\r\n";
      }
    }
  </script>
</body>

</html>
