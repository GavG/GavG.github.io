<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />
    <title>CatFlap</title>
    <style>
        html,
        body,
        .wrapper,
        #canvas {
            width: 100%;
            height: 100%;
        }

        body {
            margin: 0px;
            border: 0px;
            background-color: #333;
        }

        #canvas {
            display: block;
            background-color: #fb6;
            max-width: 500px;
            margin: auto;
        }
    </style>
</head>

<body>

    <div class='wrapper'>
        <canvas id="canvas"></canvas>
    </div>

    <script>
        var c = document.getElementById("canvas")
        var ctx = c.getContext("2d")

        let sprite_img = new Image(35, 18)
        let sprite_src = 'sprite.png'

        let original_sprite_width = 16
        let original_sprite_height = 16

        let sprite_width
        let sprite_height

        var sprite
        let sprites

        var score = 0

        var ox
        var oy

        var px
        var py

        var p_angle = 0
        var max_p_angle = 1.5
        var min_p_angle = -1.5

        var end_move_up
        var moving_up

        var unit
        var up_amount

        var acceleration = 0.15
        var down_amount

        var min_y

        var game_over
        var game_started

        var game_stepper

        var pipe_width
        var pipes = []
        var pipe_rate

        let pipe_offset_height
        let pipe_range
        let pipe_gap

        init()

        function init() {
            resize()
            set_sprite('resting')
            registerEventListeners()
            sprite_img.src = sprite_src
        }

        function reset() {
            py = oy
            px = ox
            game_over = false
            game_started = false
            draw()
        }

        function resize() {
            c.width = c.offsetWidth;
            c.height = c.offsetHeight;

            unit = c.height / 50
            up_amount = 1.2 * unit
            down_amount = unit / 4

            sprite_width = unit * 2
            sprite_height = unit * 2

            min_y = sprite_height
            max_y = c.height - min_y

            oy = (c.height / 2) - (sprite_height / 2)
            ox = (c.width / 2) - (sprite_width / 2)

            pipe_width = c.width / 21
            pipe_rate = c.width / 200

            pipe_offset_height = c.height / 5
            pipe_gap = sprite_height * 5
            pipe_range = c.height * (3 / 5)

            pipes[0] = {
                x: c.width,
                y: random_height(),
                passed: false,
            }
            pipes[1] = {
                x: c.width + pipe_width * 8,
                y: random_height(),
                passed: false,
            }
            pipes[2] = {
                x: c.width + pipe_width * 15,
                y: random_height(),
                passed: false,
            }

            sprites = {
                'resting': {
                    'offset_x': 1,
                    'offset_y': 1,
                },
                'jumping': {
                    'offset_x': 2 + original_sprite_width,
                    'offset_y': 1,
                },
            }
        }

        function draw() {
            ctx.clearRect(0, 0, c.width, c.height);

            draw_pipes()
            draw_sprite()
            draw_score()

            if (game_over) {
                ctx.fillStyle = "red";
                ctx.textAlign = "center";
                ctx.fillText("Game Over", c.width / 2, c.height / 2);
            }

            if (game_started && !game_over) {
                window.requestAnimationFrame(draw)
            }
        }

        function draw_sprite() {
            let _px = px
            let _py = py
            ctx.translate(_px, _py)
            ctx.rotate(p_angle)
            ctx.drawImage(
                sprite_img,
                sprite.offset_x,
                sprite.offset_y,
                original_sprite_width,
                original_sprite_height,
                0, 0,
                sprite_width,
                sprite_height,
            )
            ctx.rotate(-p_angle)
            ctx.translate(-_px, -_py)
        }

        function draw_score() {
            ctx.font = "30px Comic Sans MS"
            ctx.textAlign = "left"
            ctx.fillStyle = "white"
            ctx.fillText(score, 10, 40)
        }

        function game_step() {
            move_down()
            move_pipes()
        }

        function random_height() {
            return (Math.random() * pipe_range) + pipe_offset_height
        }

        function move_pipes() {
            for (var i = 0; i < pipes.length; i++) {

                pipes[i].x -= pipe_rate

                if (pipes[i].x <= -pipe_width) { //Check if pipe went off-screen
                    pipes[i].x = c.width
                    pipes[i].passed = false
                    pipes[i].y = random_height()
                } else if (!pipes[i].passed) {
                    pipe_collision_check(pipes[i])
                }
            }
        }

        function pipe_collision_check(pipe) {
            if ((px + sprite_width) > pipe.x && px < (pipe.x + pipe_width) &&
                (py < pipe.y || (py + sprite_height) > (pipe.y + pipe_gap))) {
                end_game()
            }
            if (px > (pipe.x + pipe_width)) {
                pipe.passed = true
                score += 1
            }
        }

        function draw_pipes() {
            ctx.fillStyle = "green";
            for (var i = 0; i < pipes.length; i++) {
                ctx.fillRect(
                    pipes[i].x,
                    0,
                    pipe_width,
                    pipes[i].y
                )
                ctx.fillRect(
                    pipes[i].x,
                    pipes[i].y + pipe_gap,
                    pipe_width,
                    c.height
                )
            }
        }

        function set_sprite(key) {
            sprite = sprites[key]
        }

        function move_up() {
            down_amount = unit / 5
            if (!game_over) {
                if (!game_started) {
                    game_started = true
                    game_stepper = setInterval(game_step, 20)
                }
                if (py > min_y) {
                    clearInterval(moving_up)
                    var moved_up_counter = 0
                    moving_up = setInterval(function() {
                        py -= up_amount
                        moved_up_counter += 1
                        if (moved_up_counter == 5) {
                            clearInterval(moving_up)
                        }
                    }, 20)
                }

                if (p_angle > min_p_angle) {
                    p_angle -= ((p_angle / 2) + 0.3)
                }

                set_sprite('jumping')

                clearTimeout(end_move_up)
                end_move_up = setTimeout(function() {
                    set_sprite('resting')
                }, 200)

                window.requestAnimationFrame(draw)
            }
        }

        function move_down() {
            if (!game_over) {
                if (py < max_y) {
                    py += down_amount

                    if (p_angle < max_p_angle) {
                        p_angle += 0.02
                    }

                    down_amount += acceleration
                } else {
                    end_game()
                }
            }
        }

        function end_game() {
            game_over = true
            clearInterval(moving_up)
            clearInterval(game_stepper)
            setTimeout(function() {
                // if (game_over && confirm('You died, play again?')) { // reset() // }
            }, 50)
        }

        function registerEventListeners() {
            sprite_img.addEventListener('load', function() {

                reset()

                document.addEventListener('keydown', function(e) {
                    if (e.keyCode == 32) move_up()
                })

                c.addEventListener('mousedown', move_up)
            })
        }
    </script>

</body>

</html>