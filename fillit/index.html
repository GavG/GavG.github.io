<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <title>Fill It!</title>

  <style media="screen">
    html,
    body {
      width: 100%;
      height: 100%;
    }

    body {
      margin: 0;
      font-family: arial;
      overscroll-behavior: contain;
    }

    button {
      border: none;
      background: none;
      outline: none;
    }

    #bar {
      width: 100%;
      height: 50px;
      background-color: #000;
      display: flex;
      justify-content: space-between;
      font-size: 20px;
    }

    #level_selector {
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin: 0px 10px;
    }

    #level_selector button {
      color: orange;
      font-size: 15px;
      padding: 0px;
      height: 25px;
      width: 35px;
    }

    #level_selector button:first-child {
      padding-top: 5px;
    }

    #level_selector button:last-child {
      padding-bottom: 5px;
    }

    #stage_name {
      color: white;
      line-height: 50px;
      margin-right: auto;
    }

    #retry {
      background-color: #FF0;
      color: #000;
      font-size: 28px;
      font-weight: bold;
      padding: 0px 15px;
    }

    #main {
      display: flex;
      align-items: center;
      height: calc(100% - 50px);
      position: relative;
    }

    #board {
      margin: auto;
      border-spacing: 4px;
    }

    #board td {
      height: 30px;
      width: 30px;
    }

    #board #p {
      box-sizing: border-box;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      border: solid 5px orange;
    }

    #board td._1 {
      background-color: #00E;
    }

    #board td._2 {
      background-color: #0EE;
    }

    #board td._3 {
      background-color: #ffeb3b;
    }

    #board td._4 {
      background-color: #F11;
    }
  </style>

</head>

<body>

  <div id='bar'>
    <span id='level_selector'>
      <button value='1'>&#x25B2;</button>
      <button value='-1'>&#x25BC;</button>
    </span>
    <span id='stage_name'></span>
    <button id='retry'>&#8634;</button>
  </div>

  <div id='main'>
    <table id='board'>
      <tbody>
      </tbody>
    </table>
  </div>

  <script type="text/javascript">
    const board_elem = document.getElementById('board')
    const stage_name_elem = document.getElementById('stage_name')
    const retry_elem = document.getElementById('retry')
    const level_selector = document.getElementById('level_selector')

    const up = [0, -1]
    const down = [0, 1]
    const left = [-1, 0]
    const right = [1, 0]

    const key_directions = {
      38: up,
      87: up,
      37: left,
      65: left,
      39: right,
      68: right,
      40: down,
      83: down,
    }

    var levels
    var stage
    var level = 0
    var highest_level = 0
    var touch_start

    class Stage {
      constructor(name, board) {
        this.name = name
        this.board = board
      }
    }

    class Board {
      constructor(map, x, y) {
        this.original_map = map.map(function(arr) {
          return arr.slice();
        })
        this.original_x = x
        this.original_y = y
        this.map = map
        this.x = x
        this.y = y
        this.player_elem = null
      }

      draw() {
        var new_tbody = document.createElement('tbody');
        for (var y = 0; y < this.map.length; y++) {
          var row = new_tbody.insertRow(y)
          for (var x = 0; x < this.map[y].length; x++) {
            var cell = row.insertCell(x)
            cell.classList.add('_' + this.map[y][x])
            if (x == this.x && y == this.y) {
              cell.id = 'p'
            }
          }
        }
        board_elem.replaceChild(new_tbody, board_elem.tBodies[0])
      }

      redraw() {
        for (var y = 0; y < this.map.length; y++) {
          for (var x = 0; x < this.map[y].length; x++) {
            var cell = board.rows[y].cells[x]
            cell.id = null
            cell.classList = null
            cell.classList.add('_' + this.map[y][x])
            if (x == this.x && y == this.y) {
              cell.id = 'p'
            }
          }
        }
      }

      sum() {
        var sum = 0
        for (var _y = 0; _y < this.map.length; _y++) {
          this.map[_y]
          for (var _x = 0; _x < this.map[_y].length; _x++) {
            sum += this.map[_y][_x]
          }
        }
        return sum
      }

      check_complete() {
        if (this.sum() == 0) {
          load_next_stage()
        }
      }

      move(key) {
        var [x, y] = key_directions[key] || [0, 0]

        x += this.x
        y += this.y

        if (typeof this.map[y] !== 'undefined' && this.map[y][x] > 0) {
          this.x = x
          this.y = y
          this.map[y][x] -= 1
          this.redraw()
          this.check_complete()
        }
      }

      move_to_cell(elem) {
        var y = elem.parentElement.rowIndex
        var x = elem.cellIndex
        if (!(x == this.x && y == this.y) &&
          ((y == this.y && x <= (this.x + 1) && x >= (this.x - 1)) ||
            (x == this.x && y <= (this.y + 1) && y >= (this.y - 1))) &&
          this.map[y][x] > 0
        ) {
          this.x = x
          this.y = y
          this.map[y][x] -= 1
          this.redraw()
          this.check_complete()
        }
      }

      reset() {
        this.map = this.original_map.map(function(arr) {
          return arr.slice();
        })
        this.x = this.original_x
        this.y = this.original_y
        this.draw()
      }
    }

    function load_stage(level) {
      save_level()
      if (typeof stages[level] !== 'undefined') {
        stage = stages[level]
        stage.board.draw()
        stage_name_elem.innerText = level + ': ' + stage.name
      } else {
        setTimeout(function() {
          alert('YOU WIN THE GAME! - More levels coming soon...', 500)
        })
      }
    }

    function load_next_stage() {
      load_stage(level += 1)
    }

    function save_level() {
      if (level > highest_level) {
        highest_level = level
        window.localStorage.setItem('highest_level', highest_level)
      }
    }

    function touch_move(e) {
      var point = e.changedTouches[0]
      var dx = point.clientX - touch_start.clientX
      var dy = point.clientY - touch_start.clientY

      if (dx > 30 || dx < -30) {
        stage.board.move(dx < 30 ? 37 : 39)
        touch_start = point
      }
      if (dy > 30 || dy < -30) {
        stage.board.move(dy > 30 ? 40 : 38)
        touch_start = point
      }
    }

    function init_board_touch() {
      main.addEventListener('touchmove', touch_move)
      main.addEventListener('touchstart', function(e) {
        touch_start = e.changedTouches[0]
      })
    }

    function init() {

      stages = [

        new Stage('INTRO',
          new Board([
            [0, 1, 1, 1]
          ], 0, 0)),

        new Stage('DOUBLE DECKER',
          new Board([
            [0, 1, 1, 1],
            [1, 1, 1, 1]
          ], 0, 0)),

        new Stage('TIC-TAC-TOE',
          new Board([
            [0, 1, 1],
            [1, 1, 1],
            [1, 1, 1]
          ], 0, 0)),

        new Stage('LAYERS',
          new Board([
            [0, 1, 2, 2, 2, 1, 0]
          ], 0, 0)),

        new Stage('GROOVY',
          new Board([
            [0, 2, 2, 2, 1],
            [1, 2, 2, 2, 1]
          ], 0, 0)),

        new Stage('C THIS',
          new Board([
            [0, 2, 2, 2, 1],
            [1, 2, 0, 1, 1],
            [1, 2, 2, 2, 1]
          ], 0, 0)),

        new Stage('CROSS TRAINING',
          new Board([
            [0, 0, 1, 0, 0],
            [0, 1, 2, 1, 0],
            [1, 2, 0, 2, 1],
            [0, 1, 2, 1, 0],
            [0, 0, 1, 0, 0]
          ], 1, 2)),

        new Stage('MORE NOW',
          new Board([
            [0, 1, 2, 3, 3, 2, 1, 0]
          ], 0, 0)),

        new Stage('SQUARE',
          new Board([
            [0, 1, 1, 1, 1, 1, 1],
            [1, 2, 2, 2, 2, 2, 1],
            [1, 2, 3, 3, 3, 2, 1],
            [1, 2, 3, 0, 3, 2, 1],
            [1, 2, 3, 3, 3, 2, 1],
            [1, 2, 2, 2, 2, 2, 1],
            [1, 1, 1, 1, 1, 1, 1]
          ], 0, 0)),

        new Stage('LIFT?',
          new Board([
            [0, 1, 1, 0, 0, 1, 1, 0],
            [1, 1, 1, 2, 2, 1, 1, 1],
            [1, 1, 1, 2, 2, 1, 1, 1],
            [0, 1, 1, 0, 0, 1, 1, 0]
          ], 0, 0)),

        new Stage('MAZEY DAY',
          new Board([
            [0, 1, 1, 1, 1, 1],
            [1, 0, 2, 1, 0, 1],
            [2, 0, 2, 0, 0, 1],
            [2, 1, 2, 1, 1, 2],
            [1, 0, 0, 0, 0, 2],
            [1, 3, 2, 2, 2, 3],
            [0, 2, 0, 0, 0, 1]
          ], 0, 0)),

        new Stage('SMILE',
          new Board([
            [0, 1, 1, 1, 1, 0],
            [1, 1, 1, 1, 1, 1],
            [1, 2, 1, 1, 2, 1],
            [1, 1, 1, 1, 1, 1],
            [1, 3, 3, 3, 3, 1],
            [0, 1, 3, 3, 1, 0],
            [0, 0, 1, 1, 0, 0]
          ], 0, 0)),

        new Stage('BATTENBERGS',
          new Board([
            [0, 0, 0, 0, 0, 0],
            [4, 3, 4, 3, 4, 3, 4],
            [3, 4, 3, 4, 3, 4, 3],
            [0, 0, 0, 0, 0, 0]
          ], 0, 0)),

      ]

      highest_level = parseInt(window.localStorage.getItem('highest_level') || 0)

      if (highest_level > 0) level = highest_level

      load_stage(level)

      window.addEventListener('keydown', function(e) {
        if (e.keyCode == 82) {
          stage.board.reset()
        } else {
          stage.board.move(e.keyCode)
        }
      })

      board_elem.addEventListener('click', function(e) {
        stage.board.move_to_cell(e.target)
      })

      init_board_touch()

      retry_elem.addEventListener('click', function() {
        stage.board.reset()
      })

      level_selector.addEventListener('click', function(e) {
        var selected_level = level + parseInt(e.target.value)
        if (selected_level <= highest_level && selected_level >= 0) {
          load_stage(level = selected_level)
        }
      })
    }

    window.addEventListener('load', init)
  </script>
</body>

</html>