<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <title>Fill It!</title>

  <style media="screen">
    html,
    body {
      width: 100%;
      height: 100%;
    }

    body {
      margin: 0;
      font-family: arial;
    }

    #bar {
      width: 100%;
      height: 50px;
      background-color: #000;
      display: flex;
      justify-content: space-between;
      font-size: 30px;
    }

    #bar #stage_name {
      color: white;
      line-height: 50px;
      margin: 0px 5px;
    }

    #bar #retry {
      background-color: #FF0;
      color: #000;
      border: none;
      font-size: 30px;
    }

    #main {
      display: flex;
      align-items: center;
      height: calc(100% - 50px);
    }

    #board {
      margin: auto;
      border-spacing: 4px;
    }

    #board td {
      height: 40px;
      width: 40px;
    }

    #board td.p {
      box-sizing: border-box;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      border: solid 5px orange;
    }

    #board td._1 {
      background-color: #00E;
    }

    #board td._2 {
      background-color: #0EE;
    }

    #board td._3 {
      background-color: #ffeb3b;
    }
  </style>

</head>

<body>

  <div id='bar'>
    <span id='stage_name'></span>
    <button id='retry'>RETRY (r)</button>
  </div>

  <div id='main'>
    <table id='board'>
      <tbody>
      </tbody>
    </table>
  </div>

  <script type="text/javascript">
    const board_elem = document.getElementById('board')
    const player_elem = document.getElementById('player')
    const stage_name_elem = document.getElementById('stage_name')

    const up = [0, -1]
    const down = [0, 1]
    const left = [-1, 0]
    const right = [1, 0]

    const key_directions = {
      38: up,
      87: up,
      37: left,
      65: left,
      39: right,
      68: right,
      40: down,
      83: down,
    }

    var levels
    var stage
    var level = 0

    class Stage {
      constructor(name, board) {
        this.name = name
        this.board = board
      }
    }

    class Board {
      constructor(map, x, y) {
        this.original_map = map.map(function(arr) {
          return arr.slice();
        })
        this.original_x = x
        this.original_y = y
        this.map = map
        this.x = x
        this.y = y
        this.player_elem = null
      }

      draw() {
        var new_tbody = document.createElement('tbody');
        for (var y = 0; y < this.map.length; y++) {
          var row = new_tbody.insertRow(y)
          for (var x = 0; x < this.map[y].length; x++) {
            var cell = row.insertCell(x)
            cell.classList.add('_' + this.map[y][x])
            if (x == this.x && y == this.y) {
              cell.classList.add('p')
            }
          }
        }
        board_elem.replaceChild(new_tbody, board_elem.tBodies[0])
      }

      sum() {
        var sum = 0
        for (var _y = 0; _y < this.map.length; _y++) {
          this.map[_y]
          for (var _x = 0; _x < this.map[_y].length; _x++) {
            sum += this.map[_y][_x]
          }
        }
        return sum
      }

      move(key) {

        var [x, y] = key_directions[key] || [0, 0]

        x += this.x
        y += this.y

        if (typeof this.map[y] !== 'undefined' && this.map[y][x] > 0) {
          this.x = x
          this.y = y
          this.map[y][x] -= 1
          this.draw()

          if (this.sum() == 0) {
            load_next_stage()
          }
        }
      }

      reset() {
        this.map = this.original_map.map(function(arr) {
          return arr.slice();
        })
        this.x = this.original_x
        this.y = this.original_y
        this.draw()
      }
    }

    function load_stage(level) {
      if (typeof stages[level] !== 'undefined') {
        stage = stages[level]
        stage.board.draw()
        stage_name_elem.innerText = level + ': ' + stage.name
        save_level()
      } else {
        setTimeout(function() {
          alert('YOU WIN THE GAME!', 500)
        })
      }
    }

    function load_next_stage() {
      load_stage(level += 1)
    }

    function save_level() {
      window.localStorage.setItem('level', level)
    }

    function init() {

      stages = [

        new Stage('INTRO',
          new Board([
            [0, 1, 1, 1],
          ], 0, 0)),

        new Stage('DOUBLE DECKER',
          new Board([
            [0, 1, 1, 1],
            [1, 1, 1, 1],
          ], 0, 0)),

        new Stage('TIC-TAC-TOE',
          new Board([
            [0, 1, 1],
            [1, 1, 1],
            [1, 1, 1]
          ], 0, 0)),

        new Stage('LAYERS',
          new Board([
            [1, 2, 2, 2, 1],
          ], 0, 0)),

        new Stage('GROOVY',
          new Board([
            [1, 2, 2, 2, 1],
            [1, 2, 2, 2, 1],
          ], 0, 0)),

        new Stage('C THIS',
          new Board([
            [0, 2, 2, 2, 1],
            [1, 2, 0, 1, 1],
            [1, 2, 2, 2, 1],
          ], 0, 0)),

        new Stage('CROSS TRAINING',
          new Board([
            [0, 0, 1, 0, 0],
            [0, 1, 2, 1, 0],
            [1, 2, 0, 2, 1],
            [0, 1, 2, 1, 0],
            [0, 0, 1, 0, 0],
          ], 2, 2)),

        new Stage('MORE NOW',
          new Board([
            [1, 2, 3, 3, 2, 1],
          ], 0, 0)),

      ]

      var saved_level = parseInt(window.localStorage.getItem('level'))
      if (saved_level) {
        if (confirm("Continue from highest level achieved?")) {
          level = saved_level
        } else {
          save_level(level)
        }
      }

      load_stage(level)

      window.addEventListener('keydown', function(e) {
        if (e.keyCode == 82) {
          stage.board.reset()
        } else {
          stage.board.move(e.keyCode)
        }
      })

      document.getElementById('retry').addEventListener('click', function() {
        stage.board.reset()
      })
    }

    window.addEventListener('load', init)
  </script>
</body>

</html>